{% extends "base.html" %}

{% block title %}Add Skill - Team Skills Manager{% endblock %}

{% block content %}
<div style="max-width: 800px; margin: 0 auto;">
    <div style="margin-bottom: 2rem;">
        <a href="/skills" style="color: var(--text-secondary); text-decoration: none; display: inline-flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem; transition: color 0.3s;">
            <i class="fas fa-arrow-left"></i> Back to Skills
        </a>
        <h1 style="font-size: 2.5rem; font-weight: 700; margin-bottom: 0.5rem;">
            Add New Skill
        </h1>
        <p style="color: var(--text-secondary); font-size: 1.1rem;">
            Add a new skill to your organization's catalog
        </p>
    </div>

    <div class="card">
        <form method="POST" action="/skills/add">
            <div class="form-group">
                <label for="skill_name" class="form-label">
                    <i class="fas fa-lightbulb"></i> Skill Name *
                </label>
                <input 
                    type="text" 
                    id="skill_name" 
                    name="skill_name" 
                    class="form-control" 
                    required 
                    placeholder="e.g., Python Programming, Clinical Data Analysis"
                    autocomplete="off"
                >
            </div>

            <div class="form-group">
                <label for="category" class="form-label">
                    <i class="fas fa-tag"></i> Category *
                </label>
                <select name="category" id="category" class="form-control" required>
                    <option value="">Choose a category...</option>
                    {% for cat in categories %}
                    <option value="{{ cat }}">{{ cat }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- Category Descriptions -->
            <div style="background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 12px; padding: 1.5rem; margin-top: 1.5rem;">
                <h4 style="font-weight: 600; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                    <i class="fas fa-info-circle" style="color: var(--accent-primary);"></i>
                    Category Guidelines
                </h4>
                <div style="display: grid; gap: 1rem;">
                    <div>
                        <strong style="color: var(--accent-primary);">Technical:</strong>
                        <span style="color: var(--text-secondary); font-size: 0.95rem;"> Programming languages, software tools, databases, frameworks</span>
                    </div>
                    <div>
                        <strong style="color: var(--accent-success);">Clinical:</strong>
                        <span style="color: var(--text-secondary); font-size: 0.95rem;"> Medical knowledge, patient care, clinical analysis, healthcare protocols</span>
                    </div>
                    <div>
                        <strong style="color: var(--accent-warning);">Regulatory:</strong>
                        <span style="color: var(--text-secondary); font-size: 0.95rem;"> Compliance standards (ISO, FDA, IEC), quality assurance, validation</span>
                    </div>
                    <div>
                        <strong style="color: var(--accent-secondary);">Soft Skill:</strong>
                        <span style="color: var(--text-secondary); font-size: 0.95rem;"> Communication, leadership, project management, teamwork</span>
                    </div>
                </div>
            </div>

            <!-- Role Requirements Section -->
            <div class="form-group" style="margin-top: 1.5rem;">
                <label class="form-label">
                    <i class="fas fa-user-tag" style="color: var(--accent-secondary); margin-right: 0.5rem;"></i>
                    Assign to Roles (Optional)
                </label>
                
                <!-- Column Headers (initially hidden) -->
                <div id="role-headers" style="display: none; margin-bottom: 0.5rem;">
                    <div style="display: flex; gap: 1rem; align-items: center;">
                        <div style="flex: 2;">
                            <span style="font-size: 0.875rem; font-weight: 500; color: var(--text-secondary);">Role</span>
                        </div>
                        <div style="flex: 1;">
                            <span style="font-size: 0.875rem; font-weight: 500; color: var(--text-secondary);">Min Skill Proficiency Req</span>
                        </div>
                        <div style="width: 42px;"></div>
                    </div>
                </div>

                <div id="roles-container" style="margin-bottom: 1rem;">
                    <!-- Roles will be added here dynamically -->
                </div>
                <button type="button" id="add-role-btn" class="btn btn-secondary">
                    <i class="fas fa-plus"></i> Add to Role
                </button>
                <small style="color: var(--text-muted); font-size: 0.85rem; margin-top: 0.5rem; display: block;">
                    Optionally assign this skill as a requirement to one or more roles with minimum proficiency levels
                </small>
            </div>

            <!-- Info Box -->
            <div style="background: linear-gradient(135deg, rgba(0, 217, 255, 0.05), rgba(124, 58, 237, 0.05)); padding: 1.25rem; border-radius: 10px; margin-bottom: 1.5rem; border-left: 4px solid var(--accent-primary);">
                <div style="display: flex; gap: 1rem;">
                    <i class="fas fa-info-circle" style="color: var(--accent-primary); font-size: 1.25rem; margin-top: 0.2rem;"></i>
                    <div>
                        <h4 style="font-size: 1rem; font-weight: 600; margin-bottom: 0.5rem; color: var(--text-primary);">
                            Role Requirements
                        </h4>
                        <ul style="color: var(--text-secondary); font-size: 0.9rem; line-height: 1.6; margin-left: 1.25rem;">
                            <li>Assign this skill to roles that require it</li>
                            <li>Set the <strong>minimum proficiency level</strong> required for each role</li>
                            <li>Proficiency levels: 1 (Beginner), 2 (Intermediate), 3 (Expert)</li>
                            <li>Members must meet or exceed this level to be eligible for the role</li>
                        </ul>
                    </div>
                </div>
            </div>

            <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                <button type="submit" class="btn btn-primary" style="flex: 1;">
                    <i class="fas fa-plus-circle"></i> Add Skill
                </button>
                <a href="/skills" class="btn btn-secondary">
                    <i class="fas fa-times"></i> Cancel
                </a>
            </div>
        </form>
    </div>
</div>

<script>
// Roles data from backend
const availableRoles = {{ roles_json | safe }};
let roleCounter = 0;
const selectedRoles = new Set(); // Track selected roles to prevent duplicates

// Function to get available roles (excluding already selected ones)
function getAvailableRolesOptions() {
    return availableRoles
        .filter(role => !selectedRoles.has(role.role_id.toString()))
        .map(role => `<option value="${role.role_id}">${role.role_name}</option>`)
        .join('');
}

// Function to update all role dropdowns
function updateAllRoleDropdowns() {
    document.querySelectorAll('.role-select').forEach(select => {
        const currentValue = select.value;
        const availableOptions = availableRoles
            .filter(role => role.role_id.toString() === currentValue || !selectedRoles.has(role.role_id.toString()))
            .map(role => `<option value="${role.role_id}" ${role.role_id.toString() === currentValue ? 'selected' : ''}>${role.role_name}</option>`)
            .join('');
        
        select.innerHTML = '<option value="">Select a role...</option>' + availableOptions;
    });
}

// Function to show/hide headers based on whether there are role rows
function updateHeadersVisibility() {
    const container = document.getElementById('roles-container');
    const headers = document.getElementById('role-headers');
    const hasRows = container.children.length > 0;
    headers.style.display = hasRows ? 'block' : 'none';
}

// Add role requirement row
document.getElementById('add-role-btn').addEventListener('click', function() {
    const container = document.getElementById('roles-container');
    const roleRow = document.createElement('div');
    roleRow.className = 'role-requirement-row';
    roleRow.style.cssText = 'display: flex; gap: 1rem; margin-bottom: 1rem; align-items: center;';
    roleRow.id = `role-row-${roleCounter}`;
    
    roleRow.innerHTML = `
        <div style="flex: 2;">
            <select name="role_ids[]" class="form-control role-select" data-row-id="${roleCounter}" onchange="handleRoleChange(this)">
                <option value="">Select a role...</option>
                ${getAvailableRolesOptions()}
            </select>
        </div>
        <div style="flex: 1;">
            <select name="min_proficiencies[]" class="form-control proficiency-select">
                <option value="">Min Level...</option>
                <option value="1">1 - Beginner</option>
                <option value="2">2 - Intermediate</option>
                <option value="3">3 - Expert</option>
            </select>
        </div>
        <button type="button" class="btn btn-danger" onclick="removeRoleRow(${roleCounter})" style="height: 42px; width: 42px;">
            <i class="fas fa-trash"></i>
        </button>
    `;
    
    container.appendChild(roleRow);
    roleCounter++;
    updateHeadersVisibility();
});

// Handle role selection change
function handleRoleChange(selectElement) {
    const previousValue = selectElement.dataset.previousValue;
    const newValue = selectElement.value;
    
    // Remove previous selection from the set
    if (previousValue) {
        selectedRoles.delete(previousValue);
    }
    
    // Add new selection to the set
    if (newValue) {
        selectedRoles.add(newValue);
        selectElement.dataset.previousValue = newValue;
    } else {
        delete selectElement.dataset.previousValue;
    }
    
    // Update all dropdowns to reflect available roles
    updateAllRoleDropdowns();
}

// Remove role requirement row
function removeRoleRow(id) {
    const row = document.getElementById(`role-row-${id}`);
    if (row) {
        const select = row.querySelector('.role-select');
        const selectedValue = select.dataset.previousValue;
        
        // Remove from selected roles set
        if (selectedValue) {
            selectedRoles.delete(selectedValue);
        }
        
        row.remove();
        
        // Update all remaining dropdowns
        updateAllRoleDropdowns();
        updateHeadersVisibility();
    }
}

// Form validation
document.querySelector('form').addEventListener('submit', function(e) {
    const roleSelects = document.querySelectorAll('select[name="role_ids[]"]');
    const proficiencySelects = document.querySelectorAll('select[name="min_proficiencies[]"]');
    
    // Check if any role row has a role selected but no proficiency
    for (let i = 0; i < roleSelects.length; i++) {
        if (roleSelects[i].value && !proficiencySelects[i].value) {
            e.preventDefault();
            alert('Please select a minimum proficiency level for all selected roles.');
            proficiencySelects[i].focus();
            return false;
        }
        
        if (!roleSelects[i].value && proficiencySelects[i].value) {
            e.preventDefault();
            alert('Please select a role for all proficiency levels specified.');
            roleSelects[i].focus();
            return false;
        }
    }
    
    // Original submit button disable
    const submitBtn = this.querySelector('button[type="submit"]');
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<span class="loading"></span> Adding Skill...';
});

// Auto-focus first input
document.getElementById('skill_name').focus();

// Category selection visual feedback
const categorySelect = document.getElementById('category');
categorySelect.addEventListener('change', function() {
    const colors = {
        'Technical': 'var(--accent-primary)',
        'Clinical': 'var(--accent-success)',
        'Regulatory': 'var(--accent-warning)',
        'Soft Skill': 'var(--accent-secondary)'
    };
    this.style.borderColor = colors[this.value] || 'var(--border-color)';
});
</script>

{% endblock %}